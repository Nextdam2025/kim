<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cannabis Test Report - Valenveras (PDF upload)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="logo.jpeg">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <style>
    body { background: #c9e9fc; margin: 0; font-family: 'Segoe UI', Arial, sans-serif;}
    .report-card {
      width: 790px; min-height: 1120px;
      margin: 40px auto 40px auto; background: #fff; border-radius: 24px;
      box-shadow: 0 10px 48px #2ea5db35; padding: 2.2em 2.3em 2em 2.3em; position:relative;
    }
    .topbar { display: flex; justify-content: space-between; align-items: center; }
    .topbar .logo { max-height: 74px;}
    .topbar .logo2 { max-height: 62px;}
    .title { text-align: center; font-size: 2.1em; font-weight: bold; letter-spacing: 1px; margin: 0.8em 0 0.2em 0; }
    .subtitle { text-align: center; color: #38993f; font-size: 1.07em; font-weight: bold; margin:0;}
    .date { text-align: center; color: #007acc; font-size: 1.15em; font-weight: 500; margin-bottom: 1.5em; }
    .section-title { font-size: 1.19em; color: #178144; font-weight: bold; letter-spacing: 1px; margin-bottom: .7em; margin-top: 1.4em;}
    .line { border-top: 2px solid #27acec44; margin: 1.3em 0; }
    .sample-section { display: flex; gap: 2em; }
    .sample-img { max-width: 175px; border-radius: 12px; box-shadow: 0 2px 20px #4cae7c44; }
    .sample-info { flex: 1 1 0; }
    .sample-info-row { margin-bottom: .4em; font-size: 1.08em;}
    .sample-info-label { color: #245a2f; font-weight: 500; min-width: 110px; display:inline-block;}
    .sample-info-value { color: #14406e; font-weight: bold;}
    .summary-tables { display: flex; gap: 2.2em; margin-top: 1.1em; }
    .cannabinoids, .terpenes { flex: 1; }
    .cannabinoids-table, .terpenes-table, .moisture-table { width: 100%; border-collapse: collapse; font-size: 1.07em;}
    .cannabinoids-table th, .terpenes-table th, .moisture-table th { background: #bcf6dc; color: #22815a; }
    .cannabinoids-table td, .terpenes-table td, .moisture-table td { padding: 7px 12px;}
    .terpene-bar-bg { background: #e5f4fa; border-radius: 8px; height: 19px; width: 115px; position: relative;}
    .terpene-bar-fill { border-radius: 8px; height: 100%; position: absolute; left: 0; top: 0;}
    .t-brown { background: #a7854a; } .t-green { background: #93ce39; } .t-purple { background: #8544a7; } .t-blue { background: #22b3c7; }
    .t-highlight { background: #74b53e; } .t-yellow { background: #eedf3e; }
    .moisture-table th { background: #f9e9af; color: #9c8000;}
    .disclaimer { background: #eafde5; border-radius: 9px; padding: 1.2em; margin-top: 2.1em; color: #447465; font-size:1.1em; }
    .qr-section { position: absolute; top: 2em; right: 2em; text-align: center;}
    .qr-section canvas { border-radius: 14px; border: 5px solid #b5e1c5;}
    .disclaimer-title { font-size: 1em; font-weight: bold; color: #3d884d;}
    .terpene-label { font-weight:bold; font-size:1em;}
    @media print { body, .report-card { background:#fff!important; box-shadow:none!important; } }
  </style>
</head>
<body>
  <div class="report-card" id="report-card">
    <div class="topbar">
      <img src="logo.jpeg" class="logo" alt="Left logo">
      <img src="https://valenveras.com/wp-content/uploads/2023/03/valenveras_4.0_Mesa-de-trabajo-1-copia-e1678396530601-1536x293.png" class="logo2" alt="Right logo">
    </div>
    <div class="title">CANNABIS TEST REPORT</div>
    <div class="subtitle">By Valenveras</div>
    <div class="date" id="ReportDate"></div>
    <div class="line"></div>
    <div class="sample-section">
      <div>
        <img id="SampleImage" class="sample-img" src="" style="display:none;">
      </div>
      <div class="sample-info" id="sample-info">
        <!-- Populated by script -->
      </div>
      <div class="qr-section">
        <div id="qr"></div>
      </div>
    </div>
    <div class="line"></div>
    <div class="section-title">Cannabinoids</div>
    <div class="summary-tables">
      <div class="cannabinoids">
        <table class="cannabinoids-table" id="cannabinoids-table"></table>
      </div>
      <div class="terpenes">
        <table class="terpenes-table" id="terpenes-table"></table>
      </div>
    </div>
    <div class="section-title" style="margin-top:2em;">Moisture</div>
    <table class="moisture-table" id="moisture-table"></table>
    <div class="disclaimer">
      <div class="disclaimer-title">DISCLAIMER</div>
      This test result is intended to provide indicative information about the composition of cannabis.
      The results are not certified and cannot be used for legal, medical, or commercial purposes.
    </div>
  </div>
  <div style="text-align:center; margin-top:1em;">
    <input type="file" id="pdf-input" accept="application/pdf">
    <input type="file" id="img-input" accept="image/*">
    <button onclick="downloadPDF()">Download PDF</button>
  </div>
<script>
const FIELDS = {
  Company: ["Company"],
  MaterialName: ["Material Name", "Material"],
  SampleID: ["Sample ID", "SampleId", "SampleID", "ID", "Sample"],
  LotName: ["Lot name", "Lot Name", "Lot"],
  DeviceID: ["Device Id", "Device ID", "DeviceId"],
  SupplierName: ["Supplier name", "Supplier Name"],
  CreatedBy: ["Created By", "Created by", "Contact", "Contactpersoon", "Contact Name", "Created on behalf of"],
  CreatedAt: ["Created at", "Created At", "Date", "Datum", "Test Date"],
  Location: ["Location"],
  THCTotal: ["Thc Total", "THC Total", "Total THC", "THC (%)", "THCtotal", "ThcTotal"],
  THCa: ["Thca", "THCa", "THC-Acid", "THCA"],
  CBDTotal: ["Cbd Total", "CBD Total", "Total CBD", "CBD (%)", "CBDtotal"],
  CBDa: ["Cbda", "CBDa", "CBD-Acid", "CBDA"],
  CBGTotal: ["Cbg Total", "CBG Total", "Total CBG", "CBG (%)", "CBGtotal"],
  TotalTerpenes: ["Total Terpenes", "Terpenes Total", "Totale Terpenen"],
  Limonene: ["Limonene"],
  BCaryophyllene: ["B-caryophyllene", "B-Caryophyllene", "Beta Caryophyllene"],
  GElemene: ["G-elemene", "G-Elemene", "Gelemene"],
  BMyrcene: ["B-mircene", "B-Myrcene", "Beta Myrcene"],
  Linalool: ["Linalool"],
  AHumulene: ["A-humulene", "A-Humulene", "Alpha Humulene"],
  Eudesma: ["Eudesma"],
  BPinene: ["B-pinene", "B-Pinene", "Beta Pinene"],
  APinene: ["A-pinene", "A-Pinene", "Alpha Pinene"],
  Terpinolene: ["Terpinolene"],
  Moisture: ["Moisture"],
  aW: ["Aw", "aW"]
};
function normalize(str) { return String(str||"").replace(/[\s_\-\.%:]/gi,"").toLowerCase(); }
function extractPdfText(file, cb) {
  pdfjsLib.getDocument({data:file}).promise.then(async pdf=>{
    let text = '';
    for(let i=1;i<=pdf.numPages;i++) {
      let page = await pdf.getPage(i);
      let content = await page.getTextContent();
      text += content.items.map(item=>item.str).join("\n") + "\n";
    }
    cb(text);
  });
}
function pdfTextToObj(text) {
  const out = {};
  // Extract header info
  const headerRegex = /(\w[\w\s]+):\s*(.+)/g;
  let m;
  while ((m = headerRegex.exec(text)) !== null) {
    const key = m[1].trim(), val = m[2].trim();
    for (const f in FIELDS) for (const variant of FIELDS[f]) {
      if (normalize(key) === normalize(variant)) out[f] = val;
    }
  }
  // Extract result table
  const lines = text.split('\n').map(l=>l.trim()).filter(l=>l.length);
  let inTable = false;
  lines.forEach((line,i)=>{
    // "Parameter Result Unit Range"
    if (/^Parameter\s+Result/i.test(line)) { inTable = true; return; }
    if (inTable && line.match(/^\w/)) {
      let parts = line.split(/\s+/);
      if(parts.length>=2){
        let key = parts[0]+" "+(parts[1]||"");
        let val = parts[2]||parts[1];
        // Try also using the whole line for terpenes (e.g. "B-mircene 0 % ...")
        for(const f in FIELDS) for(const variant of FIELDS[f]) {
          if(normalize(parts[0]) === normalize(variant) ||
             normalize(key) === normalize(variant)) {
            let v = parts[1];
            if(!isNaN(parseFloat(v))) out[f]=v;
            else if(!isNaN(parseFloat(parts[2]))) out[f]=parts[2];
          }
        }
      }
    }
  });
  // Special: for lines like "THC Total 22.77 % ..." etc.
  lines.forEach((line)=>{
    let m = line.match(/^([A-Za-z\-\_ ]+)\s+([0-9\.]+)\s*\%?/);
    if (m) {
      let key = m[1].trim(), val = m[2].trim();
      for (const f in FIELDS) for (const variant of FIELDS[f]) {
        if (normalize(key) === normalize(variant)) out[f]=val;
      }
    }
  });
  return out;
}
function fillReport(obj) {
  // Date
  let today = new Date();
  document.getElementById('ReportDate').innerText =
    obj.CreatedAt || today.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
  // Sample info
  let sampleHtml = `
    <div class="sample-info-row"><span class="sample-info-label">Sample ID:</span>
      <span class="sample-info-value">${obj.SampleID||""}</span></div>
    <div class="sample-info-row"><span class="sample-info-label">Sample Name</span>
      <span class="sample-info-value">${obj.MaterialName||""}</span></div>
    <div class="sample-info-row"><span class="sample-info-label">Device ID</span>
      <span class="sample-info-value">${obj.DeviceID||""}</span></div>
    <div class="sample-info-row"><span class="sample-info-label">Contact</span>
      <span class="sample-info-value">${obj.CreatedBy||""}</span></div>
    <div class="sample-info-row"><span class="sample-info-label">Company</span>
      <span class="sample-info-value">${obj.Company||""}</span></div>
    <div class="sample-info-row"><span class="sample-info-label">Supplier</span>
      <span class="sample-info-value">${obj.SupplierName||""}</span></div>
    <div class="sample-info-row"><span class="sample-info-label">Location</span>
      <span class="sample-info-value">${obj.Location||""}</span></div>
  `;
  document.getElementById('sample-info').innerHTML = sampleHtml;

  // Cannabinoids table
  const canna = [
    ["THC Total", obj.THCTotal||""],
    ["THCa", obj.THCa||""],
    ["CBD Total", obj.CBDTotal||""],
    ["CBDa", obj.CBDa||""],
    ["CBG Total", obj.CBGTotal||""],
    ["Total Terpenes", obj.TotalTerpenes||""]
  ];
  document.getElementById('cannabinoids-table').innerHTML =
    "<tr><th>Parameter</th><th>Result (%)</th></tr>" +
    canna.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`).join("");

  // Terpenes
  const terpColors = {
    "BMyrcene":"t-brown","Limonene":"t-green","Linalool":"t-purple","APinene":"t-blue","BCaryophyllene":"t-highlight"
  };
  const terps = [
    ["BMyrcene", obj.BMyrcene||""],
    ["Limonene", obj.Limonene||""],
    ["Linalool", obj.Linalool||""],
    ["APinene", obj.APinene||""],
    ["BCaryophyllene", obj.BCaryophyllene||""],
    ["GElemene", obj.GElemene||""],
    ["BPinene", obj.BPinene||""],
    ["AHumulene", obj.AHumulene||""],
    ["Eudesma", obj.Eudesma||""],
    ["Terpinolene", obj.Terpinolene||""]
  ];
  let maxVal = Math.max(...terps.map(r=>parseFloat(r[1])||0));
  document.getElementById('terpenes-table').innerHTML =
    "<tr><th>Terpene</th><th>Result (%)</th><th></th></tr>" +
    terps.map(([t,v])=>{
      let pct = maxVal ? ((parseFloat(v)||0)/maxVal*100) : 0;
      let bar = v ? `<div class="terpene-bar-bg"><div class="terpene-bar-fill ${terpColors[t]||""}" style="width:${pct}%;"></div></div>` : "";
      return `<tr>
        <td class="terpene-label">${t.replace("BMyrcene","B-Myrcene").replace("APinene","A-Pinene").replace("BCaryophyllene","B-Caryophyllene")}</td>
        <td>${v||""}</td>
        <td>${bar}</td>
      </tr>`;
    }).join("");

  // Moisture
  document.getElementById('moisture-table').innerHTML =
    "<tr><th>Parameter</th><th>Result</th></tr>" +
    [["Moisture",obj.Moisture||""],["aW",obj.aW||""]].map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`).join("");

  // QR code
  document.getElementById('qr').innerHTML = "";
  new QRious({
    element: Object.assign(document.createElement("canvas"), {width:100, height:100}),
    value: JSON.stringify(obj),
    size: 100
  }).appendTo(document.getElementById('qr'));
}

document.getElementById('pdf-input').addEventListener('change',function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    extractPdfText(new Uint8Array(ev.target.result), function(text){
      const obj = pdfTextToObj(text);
      fillReport(obj);
    });
  };
  reader.readAsArrayBuffer(file);
});
document.getElementById('img-input').addEventListener('change',function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    const img = document.getElementById('SampleImage');
    img.src = ev.target.result;
    img.style.display = 'block';
  }
  reader.readAsDataURL(file);
});
function downloadPDF() {
  html2pdf(document.getElementById('report-card'),{
    margin:0,
    filename:"Valenveras-Report.pdf",
    html2canvas:{ scale:2, useCORS: true },
    image: { type: 'jpeg', quality: 0.98 },
    jsPDF: { unit:'mm', format:'a4', orientation:'portrait' }
  });
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cannabis Test Report - Valenveras (PDF upload)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="logo.jpeg">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <style>
    body { background: #c9e9fc; margin: 0; font-family: 'Segoe UI', Arial, sans-serif;}
    .report-card {
      width: 790px; min-height: 1120px;
      margin: 40px auto 40px auto; background: #fff; border-radius: 24px;
      box-shadow: 0 10px 48px #2ea5db35; padding: 2.2em 2.3em 2em 2.3em; position:relative;
    }
    .topbar { display: flex; justify-content: space-between; align-items: center; }
    .topbar .logo { max-height: 74px;}
    .topbar .logo2 { max-height: 62px;}
    .title { text-align: center; font-size: 2.1em; font-weight: bold; letter-spacing: 1px; margin: 0.8em 0 0.2em 0; }
    .subtitle { text-align: center; color: #38993f; font-size: 1.07em; font-weight: bold; margin:0;}
    .date { text-align: center; color: #007acc; font-size: 1.15em; font-weight: 500; margin-bottom: 1.5em; }
    .section-title { font-size: 1.19em; color: #178144; font-weight: bold; letter-spacing: 1px; margin-bottom: .7em; margin-top: 1.4em;}
    .line { border-top: 2px solid #27acec44; margin: 1.3em 0; }
    .sample-section { display: flex; gap: 2em; }
    .sample-img { max-width: 175px; border-radius: 12px; box-shadow: 0 2px 20px #4cae7c44; }
    .sample-info { flex: 1 1 0; }
    .sample-info-row { margin-bottom: .4em; font-size: 1.08em;}
    .sample-info-label { color: #245a2f; font-weight: 500; min-width: 110px; display:inline-block;}
    .sample-info-value { color: #14406e; font-weight: bold;}
    .summary-tables { display: flex; gap: 2.2em; margin-top: 1.1em; }
    .cannabinoids, .terpenes { flex: 1; }
    .cannabinoids-table, .terpenes-table, .moisture-table { width: 100%; border-collapse: collapse; font-size: 1.07em;}
    .cannabinoids-table th, .terpenes-table th, .moisture-table th { background: #bcf6dc; color: #22815a; }
    .cannabinoids-table td, .terpenes-table td, .moisture-table td { padding: 7px 12px;}
    .terpene-bar-bg { background: #e5f4fa; border-radius: 8px; height: 19px; width: 115px; position: relative;}
    .terpene-bar-fill { border-radius: 8px; height: 100%; position: absolute; left: 0; top: 0;}
    .t-brown { background: #a7854a; } .t-green { background: #93ce39; } .t-purple { background: #8544a7; } .t-blue { background: #22b3c7; }
    .t-highlight { background: #74b53e; } .t-yellow { background: #eedf3e; }
    .moisture-table th { background: #f9e9af; color: #9c8000;}
    .disclaimer { background: #eafde5; border-radius: 9px; padding: 1.2em; margin-top: 2.1em; color: #447465; font-size:1.1em; }
    .qr-section { position: absolute; top: 2em; right: 2em; text-align: center;}
    .qr-section canvas { border-radius: 14px; border: 5px solid #b5e1c5;}
    .disclaimer-title { font-size: 1em; font-weight: bold; color: #3d884d;}
    .terpene-label { font-weight:bold; font-size:1em;}
    @media print { body, .report-card { background:#fff!important; box-shadow:none!important; } }
  </style>
</head>
<body>
  <div class="report-card" id="report-card">
    <div class="topbar">
      <img src="logo.jpeg" class="logo" alt="Left logo">
      <img src="https://valenveras.com/wp-content/uploads/2023/03/valenveras_4.0_Mesa-de-trabajo-1-copia-e1678396530601-1536x293.png" class="logo2" alt="Right logo">
    </div>
    <div class="title">CANNABIS TEST REPORT</div>
    <div class="subtitle">By Valenveras</div>
    <div class="date" id="ReportDate"></div>
    <div class="line"></div>
    <div class="sample-section">
      <div>
        <img id="SampleImage" class="sample-img" src="" style="display:none;">
      </div>
      <div class="sample-info" id="sample-info">
        <!-- Populated by script -->
      </div>
      <div class="qr-section">
        <div id="qr"></div>
      </div>
    </div>
    <div class="line"></div>
    <div class="section-title">Cannabinoids</div>
    <div class="summary-tables">
      <div class="cannabinoids">
        <table class="cannabinoids-table" id="cannabinoids-table"></table>
      </div>
      <div class="terpenes">
        <table class="terpenes-table" id="terpenes-table"></table>
      </div>
    </div>
    <div class="section-title" style="margin-top:2em;">Moisture</div>
    <table class="moisture-table" id="moisture-table"></table>
    <div class="disclaimer">
      <div class="disclaimer-title">DISCLAIMER</div>
      This test result is intended to provide indicative information about the composition of cannabis.
      The results are not certified and cannot be used for legal, medical, or commercial purposes.
    </div>
  </div>
  <div style="text-align:center; margin-top:1em;">
    <input type="file" id="pdf-input" accept="application/pdf">
    <input type="file" id="img-input" accept="image/*">
    <button onclick="downloadPDF()">Download PDF</button>
  </div>
<script>
/* ── configuration ───────────────────────────────────────── */

const DEBUG = false;           // ← set true to see raw rows in console

const FIELD_MAP = {
  SampleID       : ["Sample ID","SampleId","Sample","ID"],
  SampleName     : ["Sample Name","Material Name","SampleName","Material"],
  DeviceID       : ["Device ID","DeviceId","Device","Device Id"],
  Company        : ["Company","Organisation","Organization","Bedrijf"],
  SupplierName   : ["Supplier Name","Supplier"],
  CreatedBy      : ["Created By","Contact","Contactpersoon"],
  CreatedAt      : ["Created At","Created at","Date","Datum","Test Date"],
  LotName        : ["Lot Name","Lot","Batch"],
  Location       : ["Location","GPS","Locatie"],

  THCTotal       : ["THC Total","Thc Total","Total THC","THC (%)","ThcTotal"],
  THCa           : ["THCa","Thca","THC-A","THC-Acid"],
  CBDTotal       : ["CBD Total","Cbd Total","Total CBD","CBD (%)","CbdTotal"],
  CBDa           : ["CBDa","Cbda","CBD-A","CBD-Acid"],
  CBGTotal       : ["CBG Total","Cbg Total","Total CBG"],
  TotalTerpenes  : ["Total Terpenes","Terpenes Total"],

  Limonene       : ["Limonene"],
  BCaryophyllene : ["B-Caryophyllene","B-Caryophyllene","β-Caryophyllene"],
  GElemene       : ["G-Elemene","G-Elemene"],
  BMyrcene       : ["B-Myrcene","B-Myrcene","β-Myrcene"],
  Linalool       : ["Linalool"],
  AHumulene      : ["A-Humulene","A-Humulene","α-Humulene"],
  Eudesma        : ["Eudesma"],
  BPinene        : ["B-Pinene","B-Pinene","β-Pinene"],
  APinene        : ["A-Pinene","A-Pinene","α-Pinene"],
  Terpinolene    : ["Terpinolene"],

  Moisture       : ["Moisture","Moisture Content"],
  aW             : ["aW","Aw","Water Activity"]
};

/* ── utilities ───────────────────────────────────────────── */

const norm = s => String(s||"")
  .replace(/[\s_\-\.%:]/g,"")
  .replace(/β|α/gi,"b")        // greek letters → latin for match
  .toLowerCase();

function valueClean(v){
  if(v==null) return "";
  return String(v).replace(/[—–-]/g,"").replace(/%/g,"").trim();
}

/* ── mapping core ────────────────────────────────────────── */

function mapRows(rows){
  const out={};

  rows.forEach(r=>{
    // case 1: classic vertical row [key , value , …]
    if(Array.isArray(r) && r.length>1){
      const key = norm(r[0]);
      const val = valueClean(r[1]);
      for(const f in FIELD_MAP)
        if(FIELD_MAP[f].some(a=>key===norm(a))) out[f]=val;
      return;
    }

    // case 2: single-cell with colon  "Company: Valenveras Demo"
    if(Array.isArray(r) && r.length===1 && r[0].includes(":")){
      const [k , ...rest] = r[0].split(":");
      const key = norm(k);
      const val = valueClean(rest.join(":"));
      for(const f in FIELD_MAP)
        if(FIELD_MAP[f].some(a=>key===norm(a))) out[f]=val;
      return;
    }

    // case 3: horizontal header row followed by data row
    // handled later after parsing
  });

  return out;
}

function mapHorizontal(headerRow,dataRow){
  const out={};
  headerRow.forEach((h,i)=>{
    const key = norm(h);
    for(const f in FIELD_MAP)
      if(FIELD_MAP[f].some(a=>key===norm(a))) out[f]=valueClean(dataRow[i]);
  });
  return out;
}

/* ── populate DOM ────────────────────────────────────────── */

function fillHTML(obj){
  for(const id in FIELD_MAP){
    const td=document.getElementById(id);
    if(td) td.textContent=obj[id]||"";
  }
  // date at top
  document.getElementById('ReportDate').textContent=
      obj.CreatedAt ||
      new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});

  // cannabinoids table already uses static IDs in HTML; nothing to do
  // same for moisture / terpenes -> they read the td textContent

  // regenerate QR
  document.getElementById('qr').innerHTML="";
  new QRious({
    element:Object.assign(document.createElement("canvas"),{width:100,height:100}),
    value:JSON.stringify(obj),
    size:100
  }).appendTo(document.getElementById('qr'));
}

/* ── file handlers ───────────────────────────────────────── */

document.getElementById('file-input').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;

  if(/\.csv$/i.test(f.name)){
    Papa.parse(f,{
      complete(res){
        if(DEBUG) console.table(res.data.slice(0,15));
        processRows(res.data);
      }
    });
  }else if(/\.(xls|xlsx)$/i.test(f.name)){
    const fr=new FileReader();
    fr.onload=ev=>{
      const wb=XLSX.read(ev.target.result,{type:'binary'});
      const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
      if(DEBUG) console.table(rows.slice(0,15));
      processRows(rows);
    };
    fr.readAsBinaryString(f);
  }
});

function processRows(rows){
  rows = rows.filter(r=>Array.isArray(r)&&r.some(c=>String(c).trim()));
  if(!rows.length){ alert("No rows detected"); return; }

  /* detect horizontal layout */
  if(!/parameter/i.test(rows[0][0]) && rows.length>1 && rows[0].length===rows[1].length){
    const obj = mapHorizontal(rows[0],rows[1]);
    fillHTML(obj);
    return;
  }

  /* default vertical mapping */
  if(/parameter/i.test(rows[0][0])) rows.shift();   // skip header
  const obj = mapRows(rows);
  fillHTML(obj);
}

/* ── image & PDF export (unchanged) ─────────────────────── */

document.getElementById('img-input').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const fr=new FileReader();
  fr.onload=ev=>{
    const img=document.getElementById('SampleImage');
    img.src=ev.target.result; img.style.display='block';
  };
  fr.readAsDataURL(f);
});

function downloadPDF(){
  html2pdf(document.getElementById('report-card'),{
    margin:0,
    filename:"Valenveras-Report.pdf",
    html2canvas:{scale:2,useCORS:true},
    image:{type:'jpeg',quality:0.98},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
  });
}
</script>

</body>
</html>

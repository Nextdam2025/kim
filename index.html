<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Valenveras – Cannabis Test Report Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root {
      --bg:#dff2fd; --primary:#1e3d59; --accent:#64a60a;
      --text:#1e3d59; --font:"Helvetica Neue",Helvetica,Arial,sans-serif;
    }
    * { box-sizing:border-box; font-family:var(--font) }
    body { margin:0; padding:1rem; background:var(--bg); color:var(--text) }
    #container { max-width:880px; margin:auto }
    .card { background:#fff; border-radius:8px; padding:1rem 1.25rem; margin:1rem 0;
            box-shadow:0 2px 8px rgba(0,0,0,0.1) }
    .step-badge { display:inline-block; background:var(--primary); color:#fff;
                  border-radius:50%; width:26px; height:26px; text-align:center;
                  line-height:26px; margin-right:.5rem; font-weight:600 }
    .field { margin-bottom:.8rem }
    .field label { display:block; font-weight:600; margin-bottom:.3rem }
    .field input[type="text"],
    .field input[type="file"] {
      width:100%; padding:.5rem; border:2px solid var(--primary);
      border-radius:6px; font-size:1rem;
    }
    .btn { background:var(--primary); color:#fff; border:none;
           padding:.6rem 1.25rem; border-radius:6px;
           font-weight:600; cursor:pointer; margin-top:.5rem }
    .btn:disabled { opacity:.5; cursor:default }

    #uploader {
      border:2px dashed var(--primary); padding:2.5rem 1rem;
      text-align:center; border-radius:8px; margin-top:.5rem; background:#fff;
      cursor:pointer;
    }
    #uploader.dragover { background:rgba(30,61,89,0.1) }

    #report-card { background:#fff; width:800px; margin:2rem auto;
                   border-radius:12px; padding:1.5rem;
                   box-shadow:0 4px 14px rgba(0,0,0,0.15) }
    header.report-header { display:flex; align-items:center; justify-content:space-between }
    header.report-header img.logo { height:60px; object-fit:contain }
    h1.title { margin:0; font-size:2rem; text-align:center; line-height:1.1 }
    h1.title small { display:block; font-size:1rem; font-weight:normal }
    #report-date { text-align:center; margin:.5rem 0 1rem; font-weight:500 }
    .divider { height:2px; background:var(--primary); margin:1rem 0 }
    .info-grid { display:flex; justify-content:space-between; gap:1rem }
    .info-grid .info-text p { margin:.3rem 0 }
    .info-grid img.sample-photo { max-width:180px; border-radius:6px }
    h2.section-title { margin-bottom:.5rem; color:var(--primary) }
    table { width:100%; border-collapse:collapse; margin-bottom:1rem }
    th, td { padding:.6rem; border:1px solid #e0e0e0 }
    th { background:var(--primary); color:#fff; text-align:left }
    .terp-row { display:flex; align-items:center; gap:.5rem; margin:.3rem 0 }
    .terp-bar { flex:1; height:16px; background:#e0e0e0;
               border-radius:8px; overflow:hidden; position:relative }
    .terp-fill { height:100%; border-radius:8px; width:0;
                 transition:width .6s ease }
    .terp-val { width:3.5rem; text-align:right; font-weight:600 }
    .disclaimer { font-size:.85rem; line-height:1.4; margin-top:1rem }
    .qr { text-align:center; margin-top:1rem }
    .no-print { text-align:center; margin-top:1rem }
    @media print { .no-print { display:none!important } }
  </style>

  <!-- LIBRARIES -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.js';</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.6.0/docx.umd.js"></script>
</head>
<body>
  <div id="container">
    <!-- STEP 1 -->
    <section id="step1" class="card">
      <h3><span class="step-badge">1</span>Customer & Sample</h3>
      <div class="field"><label for="custName">Dispensary Name</label>
        <input id="custName" type="text" placeholder="e.g. De Kruidenier Cannabis Takeaway"></div>
      <div class="field"><label for="custLogo">Dispensary Logo</label>
        <input id="custLogo" type="file" accept="image/png,image/jpeg"></div>
      <div class="field"><label for="sampleID">Sample ID</label>
        <input id="sampleID" type="text" placeholder="C-003"></div>
      <div class="field"><label for="sampleName">Sample Name</label>
        <input id="sampleName" type="text" placeholder="Blue Haze"></div>
      <div class="field"><label for="harvestDate">Harvest Date</label>
        <input id="harvestDate" type="text" placeholder="09-Apr-2025"></div>
      <div class="field"><label for="plantType">Plant Type</label>
        <input id="plantType" type="text" placeholder="Sativa Dominant"></div>
      <div class="field"><label for="floweringTime">Flowering Time</label>
        <input id="floweringTime" type="text" placeholder="9 Weeks"></div>
      <div class="field"><label for="samplePhoto">Sample Photo</label>
        <input id="samplePhoto" type="file" accept="image/png,image/jpeg"></div>
      <button id="toStep2" class="btn" disabled>Next → Upload Lab File</button>
    </section>

    <!-- STEP 2 -->
    <section id="step2" class="card" hidden>
      <h3><span class="step-badge">2</span>Upload Lab Data (PDF/CSV/XLSX)</h3>
      <div id="uploader">
        <input id="fileInput" type="file" hidden multiple accept=".pdf,.csv,.xls,.xlsx">
        <p><strong>Drag & drop</strong> lab files or <a href="#" id="browseLink">browse</a></p>
      </div>
    </section>

    <!-- REPORT CARD -->
    <article id="report-card" hidden></article>

    <!-- DOWNLOAD CONTROLS -->
    <div class="no-print">
      <button id="dlHtml" class="btn" hidden>⬇ Download HTML</button>
      <button id="dlPdf"  class="btn" hidden>⬇ Download PDF</button>
      <button id="dlDocx" class="btn" hidden>⬇ Download Word</button>
    </div>
  </div>

  <script>
    const $ = s=>document.querySelector(s);
    window.labData={};

    // STEP1 → enable Next
    [ '#custName','#sampleID','#sampleName' ].forEach(sel=>{
      $(sel).addEventListener('input',()=>{
        $('#toStep2').disabled=!( $('#custName').value&&$('#sampleID').value&&$('#sampleName').value );
      });
    });
    $('#toStep2').onclick=()=>{ $('#step1').hidden=true; $('#step2').hidden=false; };

    // STEP2 UI
    $('#browseLink').onclick=e=>{e.preventDefault();$('#fileInput').click()};
    $('#uploader').onclick=()=>$('#fileInput').click();
    ['dragenter','dragover'].forEach(e=>$('#uploader').addEventListener(e,ev=>{ev.preventDefault();$('#uploader').classList.add('dragover')}));
    ['dragleave','drop'  ].forEach(e=>$('#uploader').addEventListener(e,ev=>{ev.preventDefault();$('#uploader').classList.remove('dragover'); if(e==='drop') handleFiles(ev.dataTransfer.files)}));
    $('#fileInput').onchange=e=>handleFiles(e.target.files);

    // Parsers
    const ext=f=>f.name.split('.').pop().toLowerCase();
    const parseCSV=f=>new Promise((res,rej)=>Papa.parse(f,{header:true,skipEmptyLines:true,complete:res,error:rej}));
    const parseXLSX=f=>new Promise((res,rej)=>{let r=new FileReader();r.onload=e=>{let wb=XLSX.read(e.target.result,{type:'binary'});res(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));};r.onerror=rej;r.readAsBinaryString(f);});
    async function parsePDF(f){
      let pdf=await pdfjsLib.getDocument({data:new Uint8Array(await f.arrayBuffer())}).promise, txt='';
      for(let p=1;p<=pdf.numPages;p++){let ct=await(pdf.getPage(p)).getTextContent();txt+=ct.items.map(i=>i.str).join(' ')+'\\n';}
      let data={};
      // catch any "Name: value" pairs
      (txt.match(/([A-Za-z ]+?)[:=]\\s*([0-9\\.\\,]+)/g)||[]).forEach(pair=>{
        let [full,name,val]=pair.split(/[:=]/); data[name.trim()]=val.trim().replace(',', '.');
      });
      return data;
    }

    async function handleFiles(files){
      let arr=[...files], data={};
      let fcsv=arr.find(f=>ext(f)==='csv'), fxls=arr.find(f=>['xls','xlsx'].includes(ext(f))), fpdf=arr.find(f=>ext(f)==='pdf');
      if(fcsv) data=(await parseCSV(fcsv))[0];
      else if(fxls) data=(await parseXLSX(fxls))[0];
      else if(fpdf) data=await parsePDF(fpdf);
      else return alert('Please upload a PDF, CSV or XLSX file.');
      window.labData=data;
      buildReport(data);
    }

    function buildReport(d){
      // logos & photos
      let logoFile=$('#custLogo').files[0], logoURL=logoFile?URL.createObjectURL(logoFile):null;
      let photoFile=$('#samplePhoto').files[0], photoURL=photoFile?URL.createObjectURL(photoFile):null;
      // sample info
      let info={
        'Sample ID':$('#sampleID').value.trim(),
        'Sample Name':$('#sampleName').value.trim(),
        'Harvest Date':$('#harvestDate').value.trim(),
        'Plant Type':$('#plantType').value.trim(),
        'Flowering Time':$('#floweringTime').value.trim()
      };
      // report container
      let card=$('#report-card');
      card.innerHTML=`
        <header class="report-header">
          ${logoURL?`<img class="logo" src="${logoURL}" alt="Logo">`:''}
          <h1 class="title">CANNABIS TEST REPORT<br><small>By Valenveras</small></h1>
          <img class="logo" src="data:image/jpeg;base64,{{VALENVERAS_LOGO_BASE64}}" alt="Valenveras">
        </header>
        <div id="report-date">${new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}</div>
        <div class="divider"></div>
        <div class="info-grid">
          <div class="info-text">
            ${Object.entries(info).map(([k,v])=>
              `<p><strong>${k}:</strong> ${v||'---'}</p>`
            ).join('')}
          </div>
          ${photoURL?`<img class="sample-photo" src="${photoURL}" alt="Sample">`:''}
        </div>
        <div class="divider"></div>
        <h2 class="section-title">LAB RESULTS</h2>
        <table>
          <tr><th>Field</th><th>Value</th></tr>
          ${Object.entries(d).map(([k,v])=>
            `<tr><td>${k}</td><td>${v}</td></tr>`
          ).join('')}
        </table>
        <div class="divider"></div>
        <footer>
          <div class="disclaimer">
            <strong>Disclaimer:</strong> Indicative only. Not certified for legal, medical, or commercial use.
          </div>
          <div id="qrContainer" class="qr"></div>
        </footer>
      `;

      // QR
      new QRCode($('#qrContainer'),{
        text:`https://yourdomain.com/reports/${info['Sample ID']}.html`,
        width:100, height:100
      });

      card.hidden=false;
      $('#dlHtml').hidden=false;
      $('#dlPdf').hidden=false;
      $('#dlDocx').hidden=false;
    }

    // DOWNLOAD: HTML
    $('#dlHtml').onclick=()=>{
      let htmlDoc=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>${$('#sampleID').value}</title>
        <style>${document.querySelector('head style').innerHTML}</style></head>
        <body>${$('#report-card').outerHTML}</body></html>`;
      let blob=new Blob([htmlDoc],{type:'text/html'}), a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download=`${$('#sampleID').value||'report'}.html`; a.click();
    };

    // DOWNLOAD: PDF
    $('#dlPdf').onclick=()=> html2pdf().set({
      margin:0.5, filename:`${$('#sampleID').value}.pdf`,
      html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'mm',format:'a4'}
    }).from($('#report-card')).save();

    // DOWNLOAD: Word
    $('#dlDocx').onclick=async()=>{
      const {{ Packer, Document, Paragraph, Table, TableRow, TableCell, TextRun, HeadingLevel }} = docx;
      let doc=new Document({ sections:[{ children:[
        new Paragraph({ text:'CANNABIS TEST REPORT', heading:HeadingLevel.TITLE }),
        new Paragraph({ text:`By Valenveras` }),
        new Paragraph({ text:`${new Date().toISOString().slice(0,10)}` }),
        new Paragraph({ text:'' }),
        new Paragraph({ text:'Sample Information', heading:HeadingLevel.HEADING_1 }),
        new Table({ rows:[
          ...Object.entries({
            'Sample ID':$('#sampleID').value,
            'Sample Name':$('#sampleName').value,
            'Harvest Date':$('#harvestDate').value,
            'Plant Type':$('#plantType').value,
            'Flowering Time':$('#floweringTime').value
          }).map(([k,v])=>new TableRow({ children:[
            new TableCell({ children:[new Paragraph(k)] }),
            new TableCell({ children:[new Paragraph(v)] })
          ]}))
        ]}),
        new Paragraph({ text:'' }),
        new Paragraph({ text:'Lab Results', heading:HeadingLevel.HEADING_1 }),
        new Table({ rows:[
          new TableRow({ children:[
            new TableCell({ children:[new Paragraph({text:'Field',bold:true})] }),
            new TableCell({ children:[new Paragraph({text:'Value',bold:true})] })
          ]}),
          ...Object.entries(window.labData).map(([k,v])=>new TableRow({ children:[
            new TableCell({ children:[new Paragraph(k)] }),
            new TableCell({ children:[new Paragraph(String(v))] })
          ]}))
        ]}),
        new Paragraph({ text:'Disclaimer', heading:HeadingLevel.HEADING_1 }),
        new Paragraph({ text:'Indicative only. Not certified for legal, medical, or commercial use.' })
      ]}] });
      let blob=await Packer.toBlob(doc), link=document.createElement('a');
      link.href=URL.createObjectURL(blob); link.download=`${$('#sampleID').value||'report'}.docx`; link.click();
    };
  </script>
</body>
</html>

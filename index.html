<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Valenveras Cannabis Report Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="logo.jpeg">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family:'Segoe UI',Arial,sans-serif; background:#f6fcfb; margin:0; }
    .container { 
      max-width:900px; 
      margin:2em auto; 
      background:#fff; 
      box-shadow:0 4px 32px #a3d5c290; 
      border-radius:18px; 
      overflow:hidden;
      min-height: 1100px;  /* Prevent PDF cutoff by making sure all content fits A4 */
      position: relative;
    }
    .header { display:flex; align-items:center; gap:24px; background:#e5f5fa; padding:2em 2em 1em 2em; }
    .header img { height:56px; }
    h1 { color:#47ae83; margin-bottom:0.2em; letter-spacing:-1px;}
    .main { display:flex; }
    .sidebar { background:#e9f5f2; min-width:250px; padding:2em 1em; text-align:center; border-right:2px solid #c8ede0; }
    .sidebar img { width:100%; border-radius:16px; margin-bottom:1.2em;}
    .qr-block { margin:2em 0 1em 0;}
    .qr-block canvas { border:4px solid #47ae83; border-radius:14px; }
    .label { font-size:1em; color:#55867a; margin-top:1.1em;}
    .content { flex:1; padding:2em;}
    table { width:100%; border-collapse:collapse; margin-bottom:1.5em;}
    th, td { padding:8px 12px; }
    th { background:#d3f4ea; color:#227a58; text-align:left;}
    tr:nth-child(even) { background:#f7fbfa; }
    tr:nth-child(odd) { background:#eef7f3; }
    .disclaimer { background:#e0f3eb; color:#447465; border-radius:8px; padding:1em 1.5em; margin-top:2em; }
    .edit { width:140px; }
    .button-row { margin:1.5em 0; display:flex; gap:1em;}
    button { background:#4fae8b; color:#fff; font-weight:bold; border:none; border-radius:6px; padding:0.7em 1.6em; font-size:1.1em; cursor:pointer; }
    button:hover { background:#319262; }
    input[type="file"] { margin:1em 0; }
    .editinput { width:90%; border-radius:5px; border:1px solid #b0d5c1; font-size:1em; padding:3px 7px;}
    .photo-box { margin: 2em 0; text-align: center; }
    .photo-box img { max-width: 200px; border-radius: 12px; box-shadow: 0 4px 16px #c8ede0; }
    @media (max-width:800px) {
      .main { flex-direction:column; }
      .sidebar { border-right:none; border-bottom:2px solid #c8ede0; }
    }
    @media print {
      body, .container { box-shadow:none!important; background:#fff!important; }
      .button-row { display:none!important; }
      .container { min-height: 1100px !important; }
    }
  </style>
</head>
<body>
<div class="container" id="pdf-container">
  <div class="header">
    <img src="logo.jpeg" alt="Valenveras Logo">
    <h1>Cannabis Test Report Builder</h1>
  </div>
  <div class="button-row" style="padding: 0 2em;">
    <label>
      <input type="file" id="file-input" accept=".csv,.xls,.xlsx,.txt" style="display:none;">
      <button onclick="document.getElementById('file-input').click()">Upload CSV/XLS/TXT</button>
    </label>
    <label>
      <input type="file" id="img-input" accept="image/*" style="display:none;">
      <button onclick="document.getElementById('img-input').click()">Upload Sample Image</button>
    </label>
    <label>
      <input type="file" id="photo-input" accept="image/*" style="display:none;">
      <button onclick="document.getElementById('photo-input').click()">Upload Product Photo</button>
    </label>
    <button onclick="downloadPDF()">Export PDF</button>
  </div>
  <div class="main">
    <div class="sidebar">
      <img id="sampleimg" src="" style="display:none;">
      <div class="photo-box"><img id="product-photo" src="" style="display:none;"></div>
      <div class="qr-block"><canvas id="qr"></canvas></div>
      <div class="label">Test Date:</div><div id="CreatedAt"></div>
      <div class="label">Location:</div><div id="Location"></div>
    </div>
    <div class="content" id="report-content">
      <table>
        <tr><td>Sample Name:</td><td class="edit" id="SampleName"></td></tr>
        <tr><td>Material:</td><td class="edit" id="MaterialName"></td></tr>
        <tr><td>Sample ID:</td><td class="edit" id="SampleID"></td></tr>
        <tr><td>Lot Name:</td><td class="edit" id="LotName"></td></tr>
        <tr><td>Device ID:</td><td class="edit" id="DeviceID"></td></tr>
        <tr><td>Company:</td><td class="edit" id="Company"></td></tr>
        <tr><td>Supplier:</td><td class="edit" id="SupplierName"></td></tr>
        <tr><td>Contact:</td><td class="edit" id="CreatedBy"></td></tr>
      </table>
      <h3>Cannabinoids</h3>
      <table>
        <tr><th>Parameter</th><th>Result (%)</th></tr>
        <tr><td>THC Total</td><td class="edit" id="THCTotal"></td></tr>
        <tr><td>THCa</td><td class="edit" id="THCa"></td></tr>
        <tr><td>CBD Total</td><td class="edit" id="CBDTotal"></td></tr>
        <tr><td>CBDa</td><td class="edit" id="CBDa"></td></tr>
        <tr><td>CBG Total</td><td class="edit" id="CBGTotal"></td></tr>
        <tr><td>Total Terpenes</td><td class="edit" id="TotalTerpenes"></td></tr>
      </table>
      <h3>Terpenes</h3>
      <table>
        <tr><th>Parameter</th><th>Result (%)</th></tr>
        <tr><td>Limonene</td><td class="edit" id="Limonene"></td></tr>
        <tr><td>B-Caryophyllene</td><td class="edit" id="BCaryophyllene"></td></tr>
        <tr><td>G-Elemene</td><td class="edit" id="GElemene"></td></tr>
        <tr><td>B-Myrcene</td><td class="edit" id="BMyrcene"></td></tr>
        <tr><td>Linalool</td><td class="edit" id="Linalool"></td></tr>
        <tr><td>A-Humulene</td><td class="edit" id="AHumulene"></td></tr>
        <tr><td>Eudesma</td><td class="edit" id="Eudesma"></td></tr>
        <tr><td>B-Pinene</td><td class="edit" id="BPinene"></td></tr>
        <tr><td>A-Pinene</td><td class="edit" id="APinene"></td></tr>
        <tr><td>Terpinolene</td><td class="edit" id="Terpinolene"></td></tr>
      </table>
      <h3>Moisture</h3>
      <table>
        <tr><td>Moisture</td><td class="edit" id="Moisture"></td></tr>
        <tr><td>aW</td><td class="edit" id="aW"></td></tr>
      </table>
      <div class="disclaimer">
        This test result is intended to provide indicative information about the composition of cannabis.
        The results are not certified and cannot be used for legal, medical, or commercial purposes.
      </div>
    </div>
  </div>
</div>
<script>
const fields = [
  "SampleName","MaterialName","SampleID","LotName","DeviceID","Company","SupplierName","CreatedBy","CreatedAt","Location",
  "THCTotal","THCa","CBDTotal","CBDa","CBGTotal","TotalTerpenes",
  "Limonene","BCaryophyllene","GElemene","BMyrcene","Linalool","AHumulene","Eudesma","BPinene","APinene","Terpinolene",
  "Moisture","aW"
];
const FIELD_MAP = {
  SampleName: ["Sample Name", "SampleName", "Sample", "Naam", "Sample Naam"],
  MaterialName: ["Material Name", "Material", "MaterialNaam"],
  SampleID: ["Sample ID", "SampleId", "ID", "Sample"],
  LotName: ["Lot Name", "Lot", "Batch"],
  DeviceID: ["Device ID", "DeviceId", "Apparaat"],
  Company: ["Company", "Bedrijf", "Organization", "Organisatie"],
  SupplierName: ["Supplier Name", "Supplier", "Leverancier"],
  CreatedBy: ["Created By", "Contact", "Contactpersoon", "Contact Name"],
  CreatedAt: ["Created At", "Date", "Datum", "Test Date"],
  Location: ["Location", "Locatie", "GPS"],
  THCTotal: ["THC Total", "Thc Total", "Total THC", "THC (%)", "THCtotal", "ThcTotal"],
  THCa: ["THCa", "THC-Acid", "THCA"],
  CBDTotal: ["CBD Total", "Cbd Total", "Total CBD", "CBD (%)", "CBDtotal"],
  CBDa: ["CBDa", "CBD-Acid", "CBDA"],
  CBGTotal: ["CBG Total", "Cbg Total", "Total CBG", "CBG (%)", "CBGtotal"],
  TotalTerpenes: ["Total Terpenes", "Terpenes Total", "Totale Terpenen"],
  Limonene: ["Limonene"],
  BCaryophyllene: ["B-Caryophyllene", "B-caryophyllene", "Beta Caryophyllene"],
  GElemene: ["G-Elemene", "G-elemene", "Gelemene"],
  BMyrcene: ["B-Myrcene", "B-mircene", "Beta Myrcene"],
  Linalool: ["Linalool"],
  AHumulene: ["A-Humulene", "A-humulene", "Alpha Humulene"],
  Eudesma: ["Eudesma"],
  BPinene: ["B-Pinene", "B-pinene", "Beta Pinene"],
  APinene: ["A-Pinene", "A-pinene", "Alpha Pinene"],
  Terpinolene: ["Terpinolene"],
  Moisture: ["Moisture", "Moisture %", "Vochtigheid"],
  aW: ["aW", "Aw", "Water Activity", "Wateractiviteit"]
};
let report = {};

function normalize(str) {
  return String(str||"").replace(/[\s_\-\.%:]/gi,"").toLowerCase();
}

function setField(id, val) {
  report[id] = val;
  const cell = document.getElementById(id);
  if(cell) {
    cell.innerHTML = `<input class="editinput" value="${val||''}" onchange="reportFieldChanged('${id}',this.value)">`;
  }
}
function reportFieldChanged(id, value) {
  setField(id, value);
  if(id==='CreatedAt') document.getElementById('CreatedAt').innerText = value;
  if(id==='Location') document.getElementById('Location').innerText = value;
  drawQR();
}
function drawQR() {
  const qr = new QRious({
    element: document.getElementById('qr'),
    value: location.href + "#"+btoa(JSON.stringify(report)).substr(0,40),
    size: 110
  });
}
function fillFields(data) {
  fields.forEach(key=>{
    setField(key, data[key] || "");
  });
  document.getElementById('CreatedAt').innerText = data.CreatedAt || "";
  document.getElementById('Location').innerText = data.Location || "";
  drawQR();
}

// Robust "vertical" (Parameter/Result) mapping
function mapVertical(rows) {
  let out = {};
  rows.forEach(row=>{
    if (!row || row.length < 2) return;
    let key = row[0];
    let val = row[1];
    for (const field in FIELD_MAP) {
      for (const variant of FIELD_MAP[field]) {
        if (normalize(key) === normalize(variant)) {
          out[field] = val;
        }
      }
    }
  });
  return out;
}

// Robust "horizontal" mapping
function mapHorizontal(header, data) {
  let out = {};
  if (!header || !data) return out;
  for (let i=0; i<header.length; ++i) {
    for (const field in FIELD_MAP) {
      for (const variant of FIELD_MAP[field]) {
        if (normalize(header[i]) === normalize(variant)) {
          out[field] = data[i];
        }
      }
    }
  }
  return out;
}

// Main handler
document.getElementById('file-input').addEventListener('change',function(e){
  const file = e.target.files[0];
  if(!file) return;
  if(file.name.match(/\.csv$/i)) {
    Papa.parse(file, {
      complete: function(res) {
        let rows = res.data.filter(r=>Array.isArray(r) && r.length > 1 && (r[0]||"").toString().trim());
        if(rows.length === 0) { alert("No data found in file."); return; }
        // If header is "Parameter", do vertical mapping
        if (/parameter/i.test(rows[0][0])) {
          fillFields(mapVertical(rows.slice(1))); // skip header
        } else if (rows.length > 1) {
          fillFields(mapHorizontal(rows[0], rows[1]));
        } else {
          alert("Could not detect valid data rows in this file.");
        }
      }
    });
  } else if(file.name.match(/\.(xls|xlsx)$/i)) {
    const reader = new FileReader();
    reader.onload = function(ev) {
      const workbook = XLSX.read(ev.target.result, {type:'binary'});
      const ws = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {header:1});
      let filtered = rows.filter(r=>Array.isArray(r) && r.length > 1 && (r[0]||"").toString().trim());
      if(filtered.length === 0) { alert("No data found in file."); return; }
      if (/parameter/i.test(filtered[0][0])) {
        fillFields(mapVertical(filtered.slice(1)));
      } else if (filtered.length > 1) {
        fillFields(mapHorizontal(filtered[0], filtered[1]));
      } else {
        alert("Could not detect valid data rows in this file.");
      }
    };
    reader.readAsBinaryString(file);
  }
});

document.getElementById('img-input').addEventListener('change',function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    const img = document.getElementById('sampleimg');
    img.src = ev.target.result;
    img.style.display = 'block';
  }
  reader.readAsDataURL(file);
});
document.getElementById('photo-input').addEventListener('change',function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    const img = document.getElementById('product-photo');
    img.src = ev.target.result;
    img.style.display = 'block';
  }
  reader.readAsDataURL(file);
});
function downloadPDF() {
  html2pdf(document.querySelector('.container'),{
    margin:0,
    filename:"Valenveras-Report.pdf",
    html2canvas:{ scale:2, useCORS: true },
    image: { type: 'jpeg', quality: 0.98 },
    jsPDF: { unit:'mm', format:'a4', orientation:'portrait' }
  });
}
</script>


</body>
</html>

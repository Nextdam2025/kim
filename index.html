<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Debug Report Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root {
      --bg:#dff2fd; --primary:#1e3d59; --accent:#64a60a;
      --text:#1e3d59; --font:sans-serif;
    }
    *{box-sizing:border-box;font-family:var(--font)}
    body{margin:0;padding:1rem;background:var(--bg);color:var(--text)}
    #container{max-width:800px;margin:auto}
    .card{background:#fff;border-radius:6px;padding:1rem;margin:1rem 0;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
    .btn{background:var(--primary);color:#fff;border:none;padding:.5rem 1rem;border-radius:4px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:default}
    #uploader{border:2px dashed var(--primary);padding:2rem;text-align:center;border-radius:6px;background:#fff;cursor:pointer}
    #uploader.dragover{background:rgba(30,61,89,.1)}
    #report-card{display:none;background:#fff;padding:1rem;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.1);margin:2rem 0}
    .field{margin-bottom:.75rem}
    .field label{display:block;font-weight:600;margin-bottom:.25rem}
    .field input[type="text"],
    .field input[type="file"]{width:100%;padding:.5rem;border:1px solid var(--primary);border-radius:4px}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{border:1px solid #ddd;padding:.5rem}
    th{background:var(--primary);color:#fff;text-align:left}
    .no-print{margin:1rem 0;text-align:center}
  </style>
</head>
<body>
  <div id="container">

    <!-- STEP 1 -->
    <section id="step1" class="card">
      <h2>1) Customer & Sample</h2>
      <div class="field">
        <label for="custName">Dispensary Name</label>
        <input id="custName" type="text" placeholder="e.g. De Kruidenier">
      </div>
      <div class="field">
        <label for="custLogo">Dispensary Logo</label>
        <input id="custLogo" type="file" accept="image/*">
      </div>
      <div class="field">
        <label for="sampleID">Sample ID</label>
        <input id="sampleID" type="text" placeholder="e.g. C-003">
      </div>
      <div class="field">
        <label for="sampleName">Sample Name</label>
        <input id="sampleName" type="text" placeholder="e.g. Blue Haze">
      </div>
      <div class="field">
        <label for="samplePhoto">Sample Photo</label>
        <input id="samplePhoto" type="file" accept="image/*">
      </div>
      <button id="toStep2" class="btn" disabled>Next →</button>
    </section>

    <!-- STEP 2 -->
    <section id="step2" class="card" hidden>
      <h2>2) Upload Lab File</h2>
      <div id="uploader">
        <input id="fileInput" type="file" hidden multiple accept=".pdf,.csv,.xls,.xlsx">
        <p><strong>Drag &amp; drop</strong> PDF/CSV/XLSX here<br>or <a href="#" id="browseLink">browse</a></p>
      </div>
    </section>

    <!-- REPORT -->
    <section id="report-card">
      <h2>Report Preview</h2>
      <div id="report-content"></div>
      <div class="no-print">
        <button id="dlHtml" class="btn">Download HTML</button>
        <button id="dlPdf"  class="btn">Download PDF</button>
      </div>
    </section>

  </div>

  <!-- LIBRARIES -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.js';</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    const $ = sel => document.querySelector(sel);
    window.labData = {};

    // Step 1 → enable Next only when all three fields are filled
    ['#custName','#sampleID','#sampleName'].forEach(id => {
      $(id).addEventListener('input', () => {
        const ok = $('#custName').value.trim() &&
                   $('#sampleID').value.trim() &&
                   $('#sampleName').value.trim();
        $('#toStep2').disabled = !ok;
      });
    });
    $('#toStep2').addEventListener('click', () => {
      console.log('Step 1 complete');
      $('#step1').hidden = true;
      $('#step2').hidden = false;
    });

    // Step 2 UI: drag/drop + browse
    $('#browseLink').addEventListener('click', e => {
      e.preventDefault(); $('#fileInput').click();
    });
    ['dragenter','dragover'].forEach(ev => {
      $('#uploader').addEventListener(ev, e => {
        e.preventDefault(); $('#uploader').classList.add('dragover');
      });
    });
    ['dragleave','drop'].forEach(ev => {
      $('#uploader').addEventListener(ev, e => {
        e.preventDefault();
        $('#uploader').classList.remove('dragover');
        if (ev === 'drop') handleFiles(e.dataTransfer.files);
      });
    });
    $('#fileInput').addEventListener('change', e => {
      handleFiles(e.target.files);
    });

    // Parsers
    const ext = f => f.name.split('.').pop().toLowerCase();
    const parseCSV = f => new Promise((res,rej) =>
      Papa.parse(f, { header:true, skipEmptyLines:true, complete:res, error:rej })
    );
    const parseXLSX = f => new Promise((res,rej) => {
      const r = new FileReader();
      r.onload = e => {
        const wb = XLSX.read(e.target.result, { type:'binary' });
        res(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
      };
      r.onerror = rej;
      r.readAsBinaryString(f);
    });
    async function parsePDF(f){
      const pdf = await pdfjsLib.getDocument({ data: await f.arrayBuffer() }).promise;
      let txt = '';
      for (let i=1; i<=pdf.numPages; i++){
        const pg = await pdf.getPage(i);
        const content = await pg.getTextContent();
        txt += content.items.map(it=>it.str).join(' ') + '\\n';
      }
      const data = {};
      (txt.match(/([A-Za-z ]+?)[:=]\\s*([0-9\\.\\,]+)/g) || [])
        .forEach(pair => {
          const [,k,v] = pair.match(/(.+?)[:=]\\s*([0-9\\.\\,]+)/);
          data[k.trim()] = v.replace(',', '.');
        });
      return data;
    }

    async function handleFiles(files){
      console.log('Files dropped/selected:', files);
      let d = {};
      const arr = Array.from(files);
      const fcsv = arr.find(f=>ext(f)==='csv'),
            fxls = arr.find(f=>['xls','xlsx'].includes(ext(f))),
            fpdf = arr.find(f=>ext(f)==='pdf');
      if (fcsv) d = (await parseCSV(fcsv))[0];
      else if (fxls) d = (await parseXLSX(fxls))[0];
      else if (fpdf) d = await parsePDF(fpdf);
      else {
        return alert('Please upload a PDF, CSV or XLSX.');
      }

      console.log('Parsed lab data:', d);
      window.labData = d;
      renderReport(d);
    }

    function renderReport(d){
      console.log('Rendering report...');
      const infoHTML = `
        <h3>Dispensary:</h3>
        <p>${$('#custName').value}</p>
        <h3>Sample ID:</h3>
        <p>${$('#sampleID').value}</p>
        <h3>Sample Name:</h3>
        <p>${$('#sampleName').value}</p>`;

      const rows = Object.entries(d).map(
        ([k,v]) => `<tr><td>${k}</td><td>${v}</td></tr>`
      ).join('');

      const reportHTML = `
        ${infoHTML}
        <h3>Lab Results</h3>
        <table>
          <tr><th>Field</th><th>Value</th></tr>
          ${rows}
        </table>`;

      $('#report-content').innerHTML = reportHTML;
      $('#report-card').style.display = 'block';
      $('#dlHtml').disabled = false;
      $('#dlPdf').disabled = false;
    }

    // Download HTML
    $('#dlHtml').addEventListener('click', ()=>{
      const html = `
        <!DOCTYPE html><html><head><meta charset="utf-8"><title>Report</title>
        <style>${document.querySelector('head style').innerHTML}</style></head>
        <body>${document.getElementById('report-content').outerHTML}</body></html>`;
      const blob = new Blob([html], { type:'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${$('#sampleID').value || 'report'}.html`;
      a.click();
    });

    // Download PDF
    $('#dlPdf').addEventListener('click', ()=>{
      html2pdf().from($('#report-content')).set({
        margin:0.5, filename:`${$('#sampleID').value||'report'}.pdf`,
        html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4'}
      }).save();
    });
  </script>
</body>
</html>

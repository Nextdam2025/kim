<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Valenveras – Cannabis Test Report Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- ───── STYLES ───── -->
  <style>
    :root {
      --bg:#e5f4ff; --primary:#007acc; --accent:#64a60a;
      --text:#000; --font:"Helvetica Neue",Helvetica,Arial,sans-serif;
    }
    *{box-sizing:border-box;font-family:var(--font)}
    body{margin:0;padding:1rem;background:var(--bg);color:var(--text)}
    #container{max-width:880px;margin:auto}

    /* wizard */
    .card{background:#fff;border-radius:8px;padding:1rem 1.25rem;margin:1rem 0;
          box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .step-badge{display:inline-block;background:var(--primary);color:#fff;
                border-radius:50%;width:26px;height:26px;text-align:center;
                line-height:26px;margin-right:.5rem;font-weight:600}
    .field{margin-bottom:.8rem}
    .field label{display:block;font-weight:600;margin-bottom:.3rem}
    .field input[type="text"],
    .field input[type="date"],
    .field input[type="file"]{
      width:100%;padding:.5rem;border:2px solid var(--primary);
      border-radius:6px;font-size:1rem
    }
    .btn{background:var(--primary);color:#fff;border:none;
         padding:.6rem 1.25rem;border-radius:6px;
         font-weight:600;cursor:pointer;margin-top:.5rem}
    .btn:disabled{opacity:.5;cursor:default}
    #uploader{border:2px dashed var(--primary);padding:2.5rem 1rem;
              text-align:center;border-radius:8px;margin-top:.5rem}
    #uploader.dragover{background:var(--bg)}

    /* report */
    #report-card{background:#fff;width:800px;margin:2rem auto;
                 border-radius:12px;padding:1.25rem;
                 box-shadow:0 4px 14px rgba(0,0,0,0.15)}
    header{display:flex;align-items:center;justify-content:space-between}
    header img.logo{height:80px;object-fit:contain}
    h1.title{margin:0;font-size:2.5rem;text-align:center;line-height:1.1}
    h1.title small{display:block;font-size:1rem;font-weight:normal}
    #report-date{text-align:center;margin:.5rem 0 1rem;font-weight:500}
    .divider{height:2px;background:var(--primary);margin:1rem 0}
    dl{margin:0}
    dt{font-weight:600;margin-top:.4rem}
    dd{margin:0 0 .4rem 0}
    .grid-two{display:grid;grid-template-columns:1fr 1fr;gap:0 1.75rem}
    .grid-two div{margin:.25rem 0}
    .grid-two span:first-child{font-weight:600}
    .grid-two span:last-child{text-align:right;display:block}

    .terp-row{display:flex;align-items:center;gap:.5rem;margin:.3rem 0}
    .terp-bar{flex:1;height:16px;background:#e0e0e0;border-radius:8px;
              overflow:hidden;position:relative}
    .terp-fill{height:100%;border-radius:8px;width:0%;
               transition:width .6s ease}
    .terp-val{width:3.5rem;text-align:right;font-weight:600}

    footer{margin-top:1rem;font-size:.85rem;line-height:1.4}
    .no-print{text-align:center;margin-top:1rem}
    @media print{.no-print{display:none!important}}
  </style>

  <!-- ───── LIBRARIES ───── -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
  <script>
    // **IMPORTANT**: tell PDF.js where its worker lives:
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.js';
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>
  <div id="container">
    <!-- STEP 1 -->
    <section class="card">
      <h3><span class="step-badge">1</span>Customer & Sample</h3>
      <div class="field">
        <label for="custName">Company / Dispensary name</label>
        <input id="custName" type="text" placeholder="e.g. De Kruidenier Cannabis Takeaway">
      </div>
      <div class="field">
        <label for="custLogo">Upload customer logo (PNG/JPG)</label>
        <input id="custLogo" type="file" accept="image/png,image/jpeg">
      </div>
      <div class="field">
        <label for="sampleID">Sample ID</label>
        <input id="sampleID" type="text" placeholder="e.g. C-003">
      </div>
      <div class="field">
        <label for="sampleName">Sample Name</label>
        <input id="sampleName" type="text" placeholder="e.g. El Dorado test">
      </div>
      <div class="field">
        <label for="harvestDate">Harvest Date</label>
        <input id="harvestDate" type="date">
      </div>
      <div class="field">
        <label for="plantType">Plant Type</label>
        <input id="plantType" type="text" placeholder="e.g. Sativa dominant">
      </div>
      <div class="field">
        <label for="floweringTime">Flowering Time</label>
        <input id="floweringTime" type="text" placeholder="e.g. 9 Weeks">
      </div>
      <div class="field">
        <label for="samplePhoto">Upload sample photo (PNG/JPG)</label>
        <input id="samplePhoto" type="file" accept="image/png,image/jpeg">
      </div>
      <button id="toStep2" class="btn" disabled>Next → Upload lab file</button>
    </section>

    <!-- STEP 2 -->
    <section id="step2" class="card" hidden>
      <h3><span class="step-badge">2</span>Upload NeoScanner export</h3>
      <div id="uploader">
        <input type="file" id="fileInput" hidden multiple
               accept=".pdf,.csv,.xls,.xlsx">
        <p><strong>Drag & drop</strong> PDF + CSV/XLS/XLSX<br>
           or <a href="#" id="browseLink">browse</a>…</p>
      </div>
    </section>

    <!-- REPORT -->
    <article id="report-card" hidden></article>

    <!-- DOWNLOAD -->
    <div class="no-print">
      <button id="dlHtml" class="btn" hidden>Download HTML</button>
      <button id="dlPdf" class="btn" hidden>Download PDF</button>
    </div>
  </div>

  <script>
  const $ = s => document.querySelector(s);

  // STEP 1 → enable Step 2
  const cname=$('#custName'), sid=$('#sampleID'), sname=$('#sampleName'),
        toStep=$('#toStep2');
  function chk1(){
    toStep.disabled = !(cname.value.trim() && sid.value.trim() && sname.value.trim());
  }
  [cname,sid,sname].forEach(el=>el.addEventListener('input',chk1));
  toStep.onclick = ()=> $('#step2').hidden = false;

  // STEP 2 UI
  const up=$('#uploader'), fileIn=$('#fileInput'), browse=$('#browseLink');
  browse.onclick = e=>{ e.preventDefault(); fileIn.click() };
  ['dragenter','dragover'].forEach(ev=>
    up.addEventListener(ev,e=>{ e.preventDefault(); up.classList.add('dragover') })
  );
  ['dragleave','drop'].forEach(ev=>
    up.addEventListener(ev,e=>{
      e.preventDefault(); up.classList.remove('dragover');
      if(ev==='drop') handleFiles(e.dataTransfer.files);
    })
  );
  fileIn.onchange = e=> handleFiles(e.target.files);

  // Parsers
  const ext = f=>f.name.split('.').pop().toLowerCase();
  const parseCSV = f=>new Promise((res,rej)=>
    Papa.parse(f,{preview:2,skipEmptyLines:true,
      complete:({data})=>res(data),error:rej})
  );
  const parseXLSX = f=>new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=e=>{
      const wb=XLSX.read(e.target.result,{type:'binary'});
      const all=XLSX.utils.sheet_to_json(
        wb.Sheets[wb.SheetNames[0]],{header:1}
      ).slice(0,2);
      res(all);
    };
    r.onerror=rej; r.readAsBinaryString(f);
  });

  async function parsePDF(f){
    const pdf = await pdfjsLib
      .getDocument({data:new Uint8Array(await f.arrayBuffer())})
      .promise;
    let txt="";
    for(let p=1;p<=pdf.numPages;p++){
      const ct=(await (await pdf.getPage(p)).getTextContent()).items;
      txt += ct.map(i=>i.str).join(" ") + "\n";
    }
    // include TOTAL TERPENES
    const keys=[
      "thc total","thca","cbd total","cbda","cbg total",
      "total terpenes",
      "limonene","b-caryophyllene","g-elemene","b-mircene",
      "linalool","a-humulene","eudesma","b-pinene","a-pinene","terpinolene",
      "moisture","aw"
    ];
    const summary={};
    keys.forEach(key=>{
      const re=new RegExp(
        key.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&") +
        "\\s*[:=]?\\s*([0-9]+(?:[\\.,][0-9]+)?)%?","i"
      );
      const m=txt.match(re);
      if(m) summary[key]=m[1].replace(",",".");
    });
    return summary;
  }

  function strip(u){return u.replace(/\s*\(.*?\)\s*/g,"").trim().toLowerCase()}
  function tidy(rows){
    rows=rows.filter(r=>r[0]).map(r=>r.map(String));
    if(rows[0].length>2){
      const hdr=rows.shift().map(strip),o={};
      rows.forEach(r=>hdr.forEach((k,i)=>k&&r[i]&&(o[k]=r[i])));
      return o;
    } else {
      const o={};
      rows.forEach(r=>o[strip(r[0])]=r[1]);
      return o;
    }
  }

  async function handleFiles(files){
    const list=Array.from(files);
    const pdfF=list.find(f=>ext(f)==='pdf');
    const csvF=list.find(f=>/(csv|xls|xlsx)$/.test(ext(f)));
    let o={};
    if(pdfF){
      o = await parsePDF(pdfF);
    } else if(csvF){
      const rows = ext(csvF)==='csv'
        ? await parseCSV(csvF)
        : await parseXLSX(csvF);
      const tmp = tidy(rows);
      if(tmp["thc total"]||tmp["thca"]) o = tmp;
      else return alert("CSV lacks summary – include the PDF.");
    } else {
      return alert("Upload at least the PDF summary (or summary CSV/XLS).");
    }
    buildReport(o);
  }

  function buildReport(o){
    // gather inputs
    const logoF=$('#custLogo').files[0],
          logoURL=logoF?URL.createObjectURL(logoF):'logo_placeholder.png',
          photoF=$('#samplePhoto').files[0],
          photoURL=photoF?URL.createObjectURL(photoF):null;
    const sid=$('#sampleID').value.trim(),
          sname=$('#sampleName').value.trim(),
          hdVal=$('#harvestDate').value,
          hd=hdVal?new Date(hdVal).toLocaleDateString(undefined,{
            day:'2-digit',month:'short',year:'numeric'}):"",
          ptype=$('#plantType').value.trim(),
          ftime=$('#floweringTime').value.trim();

    const canna=['thc total','thca','cbd total','cbda','cbg total'];
    const moist=['moisture','moisture content','aw','water activity'];
    const terps=[
      'total terpenes',
      'limonene','b-caryophyllene','g-elemene','b-mircene',
      'linalool','a-humulene','eudesma','b-pinene','a-pinene','terpinolene'
    ];
    const terpCols={
      'total terpenes':'#64a60a',
      limonene:'#FFD700','b-caryophyllene':'#A0522D','g-elemene':'#228B22',
      'b-mircene':'#8A2BE2','linalool':'#FFB6C1','a-humulene':'#FF8C00',
      eudesma:'#20B2AA','b-pinene':'#32CD32','a-pinene':'#008000','terpinolene':'#7FFF00'
    };

    const card=$('#report-card');
    card.innerHTML=`
      <header>
        <img src="${logoURL}" class="logo" alt="Customer logo">
        <h1 class="title">CANNABIS TEST REPORT<br><small>By Valenveras</small></h1>
        <img src="https://valenveras.com/wp-content/uploads/2023/03/valenveras_4.0_Mesa-de-trabajo-1-copia-e1678396530601-1536x293.png" class="logo" alt="Valenveras logo">
      </header>
      <p id="report-date">${new Date().toLocaleDateString(undefined,{
        day:'2-digit',month:'short',year:'numeric'})}</p>
      <div class="divider"></div>
      <section style="display:flex;justify-content:space-between">
        <dl>
          <dt>Sample ID:</dt><dd>${sid}</dd>
          <dt>Sample Name:</dt><dd>${sname}</dd>
          <dt>Harvest Date:</dt><dd>${hd}</dd>
          <dt>Plant Type:</dt><dd>${ptype}</dd>
          <dt>Flowering Time:</dt><dd>${ftime}</dd>
        </dl>
        ${photoURL?`<figure style="margin:0">
          <img src="${photoURL}" style="max-width:200px;border-radius:6px">
          <figcaption style="text-align:center">${sname}</figcaption>
        </figure>`:""}
      </section>
      <div class="divider"></div>
      <div style="margin-bottom:1.25rem">
        <h2>Cannabinoids</h2>
        <div class="grid-two">${
          canna.map(k=>o[k]?`<div><span>${k.toUpperCase()}</span><span>${o[k]}%</span></div>`:'').join('')
        }</div>
      </div>
      <h2>Terpene Profile</h2>
      <div id="terpene-wrapper"></div>
      <div class="divider"></div>
      <div class="grid-two" style="max-width:300px">${
        moist.map(k=>o[k]?`<div><span>${k.replace('aw','aW')}</span><span>${o[k]}%</span></div>`:'').join('')
      }</div>
      <div class="divider"></div>
      <footer>
        <h2>Disclaimer</h2>
        <p>This test result is intended to provide indicative information about the composition of cannabis. The results are not certified and cannot be used for legal, medical, or commercial purposes.</p>
        <div id="qrContainer"></div>
      </footer>`;

    // show & enable
    card.hidden=false;
    $('#dlHtml').hidden=false;
    $('#dlPdf').hidden=false;

    // render bars
    const wrap=$('#terpene-wrapper');
    wrap.innerHTML="";
    // compute max including total terpenes
    const vals=terps.map(k=>parseFloat((o[k]||'').replace(',','.'))||0);
    const mx=Math.max(...vals,1);
    terps.forEach(k=>{
      if(o[k]!==undefined){
        const val=parseFloat(o[k].replace(',','.'))||0;
        const pct=val/mx*100;
        const c=terpCols[k]||'var(--accent)';
        wrap.insertAdjacentHTML('beforeend',`
          <div class="terp-row">
            <span>${k.replace(/(^|\s)\w/g,m=>m.toUpperCase())}</span>
            <div class="terp-bar"><div class="terp-fill" style="width:${pct}%;background:${c}"></div></div>
            <span class="terp-val">${o[k]}%</span>
          </div>`);
      }
    });
    wrap.querySelectorAll('.terp-fill').forEach(f=>{
      const w=f.style.width; f.style.width="0%";
      setTimeout(()=>f.style.width=w,20);
    });

    // QR
    new QRCode($('#qrContainer'),{text:`${sname}|${sid}`,width:120,height:120});
  }

  // Download HTML
  $('#dlHtml').onclick=()=>{
    const r=$('#report-card').outerHTML;
    const html=`<!DOCTYPE html><html><head><meta charset="utf-8">
      <title>Report</title><style>
      /* minimal CSS for rendering above report */
      :root{--primary:#007acc;--divider:#007acc;--accent:#64a60a;--font:"Helvetica Neue",Arial,sans-serif}
      body{margin:0;padding:1rem;font-family:var(--font);background:#e5f4ff;color:#000}
      #report-card{background:#fff;width:800px;margin:2rem auto;border-radius:12px;padding:1.25rem;
                   box-shadow:0 4px 14px rgba(0,0,0,0.15)}
      header{display:flex;align-items:center;justify-content:space-between}
      .divider{height:2px;background:var(--divider);margin:1rem 0}
      .grid-two{display:grid;grid-template-columns:1fr 1fr;gap:0 1.75rem}
      .terp-row{display:flex;align-items:center;gap:.5rem;margin:.3rem 0}
      .terp-bar{flex:1;height:16px;background:#e0e0e0;border-radius:8px;overflow:hidden}
      .terp-fill{height:100%;border-radius:8px;transition:width .6s ease}
      .terp-val{width:3.5rem;text-align:right;font-weight:600}
      footer{margin-top:1rem;font-size:.85rem;line-height:1.4}
      </style></head><body>${r}</body></html>`;
    const blob=new Blob([html],{type:'text/html'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='valenveras_report.html';
    a.click();
  };

  // Download PDF
  $('#dlPdf').onclick=()=>{
    html2pdf().set({
      margin:[0.5,0.5,0.5,0.5],
      filename:'valenveras_report.pdf',
      image:{type:'jpeg',quality:1},
      html2canvas:{scale:2,useCORS:true,allowTaint:true},
      jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
    }).from($('#report-card')).save();
  };
  </script>
</body>
</html>

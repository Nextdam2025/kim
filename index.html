<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Report Builder – Debug Version</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    .card { border: 1px solid #ccc; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; }
    #uploader { border: 2px dashed #1e3d59; padding: 2rem; text-align: center; cursor: pointer; }
    #uploader.dragover { background: #eef; }
    #report { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #aaa; padding: .5rem; }
    th { background: #1e3d59; color: #fff; }
  </style>
</head>
<body>

  <!-- STEP 1 -->
  <div id="step1" class="card">
    <h2>Step 1: Enter Basic Info</h2>
    <label>Dispensary Name<br>
      <input id="custName" type="text" placeholder="De Kruidenier">
    </label><br><br>
    <label>Sample ID<br>
      <input id="sampleID" type="text" placeholder="C-003">
    </label><br><br>
    <label>Sample Name<br>
      <input id="sampleName" type="text" placeholder="Blue Haze">
    </label><br><br>
    <button id="toStep2" disabled>Next → Step 2</button>
  </div>

  <!-- STEP 2 -->
  <div id="step2" class="card" hidden>
    <h2>Step 2: Upload Lab File</h2>
    <div id="uploader">
      <p>Drag &amp; drop PDF/CSV/XLSX here<br>or click to browse</p>
      <input id="fileInput" type="file" accept=".pdf,.csv,.xls,.xlsx" hidden>
    </div>
  </div>

  <!-- REPORT -->
  <div id="report" class="card">
    <h2>Report Preview</h2>
    <div id="basicInfo"></div>
    <table id="resultsTable">
      <thead><tr><th>Field</th><th>Value</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- LIBRARIES -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.js';

    // Helpers
    const $ = id => document.getElementById(id);
    window.labData = {};

    // Step 1 → enable Next when all three are filled
    ['custName','sampleID','sampleName'].forEach(id => {
      $(id).addEventListener('input', () => {
        const ok = $('custName').value.trim() &&
                   $('sampleID').value.trim() &&
                   $('sampleName').value.trim();
        $('toStep2').disabled = !ok;
      });
    });
    $('toStep2').addEventListener('click', () => {
      console.log('→ Step 1 complete');
      $('step1').hidden = true;
      $('step2').hidden = false;
    });

    // Step 2 UI: click & drag/drop
    const uploader = $('uploader'), fileInput = $('fileInput');
    uploader.addEventListener('click', () => fileInput.click());
    ['dragenter','dragover'].forEach(e =>
      uploader.addEventListener(e, ev => {
        ev.preventDefault();
        uploader.classList.add('dragover');
      })
    );
    ['dragleave','drop'].forEach(e =>
      uploader.addEventListener(e, ev => {
        ev.preventDefault();
        uploader.classList.remove('dragover');
        if (e === 'drop') handleFiles(ev.dataTransfer.files);
      })
    );
    fileInput.addEventListener('change', e => {
      handleFiles(e.target.files);
    });

    // Parsers
    const ext = f => f.name.split('.').pop().toLowerCase();
    const parseCSV = f => new Promise((res,rej) =>
      Papa.parse(f, { header:true, skipEmptyLines:true, complete:res, error:rej })
    );
    const parseXLSX = f => new Promise((res,rej) => {
      const reader = new FileReader();
      reader.onload = e => {
        const wb = XLSX.read(e.target.result, { type:'binary' });
        res(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
      };
      reader.onerror = rej;
      reader.readAsBinaryString(f);
    });
    async function parsePDF(f){
      const pdf = await pdfjsLib.getDocument({ data: await f.arrayBuffer() }).promise;
      let text = '';
      for (let i=1; i<=pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(i=>i.str).join(' ') + '\n';
      }
      const data = {};
      (text.match(/([A-Za-z ]+?)[:=]\s*([0-9\.,]+)/g) || [])
        .forEach(pair => {
          const [,key,val] = pair.match(/(.+?)[:=]\s*([0-9\.,]+)/);
          data[key.trim()] = val.replace(',', '.');
        });
      return data;
    }

    // Handle uploads
    async function handleFiles(files){
      console.log('Files received:', files);
      let data = {};
      const arr = Array.from(files);
      const fcsv = arr.find(f=>ext(f)==='csv'),
            fxls = arr.find(f=>['xls','xlsx'].includes(ext(f))),
            fpdf = arr.find(f=>ext(f)==='pdf');
      if (fcsv) data = (await parseCSV(fcsv))[0];
      else if (fxls) data = (await parseXLSX(fxls))[0];
      else if (fpdf) data = await parsePDF(fpdf);
      else return alert('Please upload PDF, CSV, or XLSX');

      console.log('Parsed data:', data);
      window.labData = data;
      renderReport(data);
    }

    // Render the table
    function renderReport(d){
      console.log('Rendering report...');
      // Basic info
      $('basicInfo').innerHTML = `
        <strong>Dispensary:</strong> ${$('custName').value}<br>
        <strong>Sample ID:</strong> ${$('sampleID').value}<br>
        <strong>Sample Name:</strong> ${$('sampleName').value}
      `;

      // Lab fields
      const tbody = $('resultsTable').querySelector('tbody');
      tbody.innerHTML = Object.entries(d).map(([k,v]) =>
        `<tr><td>${k}</td><td>${v}</td></tr>`
      ).join('');

      $('report').style.display = 'block';
    }
  </script>
</body>
</html>

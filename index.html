<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Cannabis Test Report</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #2a7d6a;
      --secondary: #e0f1ed;
      --accent: #297373;
      --bg-light: #f7f7f7;
      --text-dark: #333;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-light);
      color: var(--text-dark);
    }
    .container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 3px solid var(--accent);
      padding-bottom: 10px;
    }
    .header img.logo {
      height: 60px;
    }
    .header img.customer-logo {
      height: 50px;
      margin-left: 15px;
    }
    .header h1 {
      font-size: 2rem;
      color: var(--primary);
      margin: 0;
    }
    .upload-section {
      margin: 20px 0;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .upload-section label {
      font-weight: bold;
      display: block;
      margin-bottom: 4px;
    }
    .upload-section input[type=file] {
      width: 100%;
      padding: 8px;
      border: 2px dashed var(--secondary);
      border-radius: 8px;
      background: #fafafa;
      cursor: pointer;
    }
    #generateBtn, #downloadBtn {
      background-color: var(--accent);
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 10px;
    }
    #generateBtn:hover, #downloadBtn:hover {
      background-color: var(--primary);
    }
    .report-container {
      margin-top: 30px;
      animation: fadeIn 0.8s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);}  
    }
    .report-header {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      background: var(--secondary);
      padding: 15px;
      border-radius: 8px;
    }
    .report-header .field {
      font-size: 0.9rem;
    }
    .section {
      margin-top: 40px;
    }
    .section h2 {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
      padding-bottom: 4px;
      margin-bottom: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background-color: var(--secondary);
      font-weight: bold;
    }
    .chart-container {
      position: relative;
      width: 100%;
      height: 400px;
      margin-top: 20px;
    }
    .disclaimer {
      margin-top: 40px;
      font-size: 0.8rem;
      color: #666;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>CANNABIS TEST REPORT</h1>
      <img src="data:image/jpeg;base64,/9j/..." class="logo" alt="Valenveras Logo">
    </div>
    <div class="upload-section">
      <div style="flex:1 1 300px;">
        <label for="csvFile">Lab Results CSV</label>
        <input type="file" id="csvFile" accept=".csv">
      </div>
      <div style="flex:1 1 300px;">
        <label for="customerLogo">Customer Logo (optional)</label>
        <input type="file" id="customerLogo" accept="image/*">
      </div>
    </div>
    <button id="generateBtn">Generate Report</button>

    <div id="report" class="report-container" style="display:none;">
      <div class="report-header" id="sampleInfo"></div>

      <div class="section" id="cannabinoidsSection">
        <h2>Cannabinoids Profile</h2>
        <table id="cannabinoidsTable">
          <thead><tr><th>Parameter</th><th>Result (%)</th><th>Range</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="chart-container"><canvas id="cannabinoidChart"></canvas></div>
      </div>

      <div class="section" id="terpenesSection">
        <h2>Terpenes Profile</h2>
        <table id="terpenesTable">
          <thead><tr><th>Parameter</th><th>Result (%)</th><th>Range</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="chart-container"><canvas id="terpeneChart"></canvas></div>
      </div>

      <div class="section" id="moistureSection">
        <h2>Moisture &amp; Water Activity</h2>
        <p><strong>Moisture:</strong> <span id="moisture"></span></p>
        <p><strong>aW:</strong> <span id="aw"></span></p>
      </div>

      <button id="downloadBtn">Download Full Report</button>
      <p class="disclaimer">This is an indicative report. Not certified for legal or medical use.</p>
    </div>
  </div>

  <script>
    // Parse CSV, strip quotes/newlines
    function parseCSV(text) {
      const [headerLine, dataLine] = text.trim().split(/\r?\n/);
      const headers = headerLine.replace(/"/g, '').split(',');
      const values = dataLine.replace(/"/g, '').split(',');
      const data = {};
      headers.forEach((h,i) => data[h.trim()] = values[i] ? values[i].trim() : '');
      return data;
    }

    // Sample info mapping
    const sampleMapping = [
      { label: 'Sample Name', key: 'Sample Name' },
      { label: 'Created At', key: 'Created At (UTC)' },
      { label: 'Device ID', key: 'Device ID' },
      { label: 'Created By', key: 'Created By' },
      { label: 'On Behalf', key: 'On Behalf' },
      { label: 'Lots Name', key: 'Lots Name' }
    ];

    // Cannabinoid and terpene definitions
    const cannabinoidParams = [
      { key: 'THC Total (%)', name: 'THC Total', range: '0.00 - 29.00' },
      { key: 'THCa(%)', name: 'THCa', range: '0.00 - 100.00' },
      { key: 'CBD Total (%)', name: 'CBD Total', range: '0.00 - 30.00' },
      { key: 'CBDa(%)', name: 'CBDa', range: '0.00 - 100.00' },
      { key: 'CBG Total(%)', name: 'CBG Total', range: '0.00 - 2.50' },
      { key: 'Total Terpenes(%)', name: 'Total Terpenes', range: '0.00 - 3.00' }
    ];
    const terpeneParams = [
      { key: 'Limonene(%)', name: 'Limonene', range: '0.00 - 3.00' },
      { key: 'B-Caryophyllene(%)', name: 'B-Caryophyllene', range: '0.00 - 2.00' },
      { key: 'G-elemene(%)', name: 'G-Elemene', range: '0.00 - 0.80' },
      { key: 'B-Mircene(%)', name: 'B-Myrcene', range: '0.00 - 10.00' },
      { key: 'Linalool(%)', name: 'Linalool', range: '0.00 - 1.00' },
      { key: 'A-Humulene(%)', name: 'A-Humulene', range: '0.00 - 0.50' },
      { key: 'Eudesma(%)', name: 'Eudesma', range: '0.00 - 1.00' },
      { key: 'B-Pinene(%)', name: 'B-Pinene', range: '0.00 - 0.10' },
      { key: 'A-Pinene(%)', name: 'A-Pinene', range: '0.00 - 0.30' },
      { key: 'Terpinolene(%)', name: 'Terpinolene', range: '0.00 - 0.20' }
    ];

    // Populate sample info
    function populateSampleInfo(data) {
      const container = document.getElementById('sampleInfo');
      container.innerHTML = sampleMapping.map(item => `
        <div class="field"><strong>${item.label}:</strong> ${data[item.key]||'--'}</div>
      `).join('');
    }

    // Fill table rows
    function fillTable(tableId, rows) {
      document.querySelector(`${tableId} tbody`).innerHTML = rows.map(r => `
        <tr><td>${r.name}</td><td>${r.value}</td><td>${r.range}</td></tr>
      `).join('');
    }

    // Create bar chart
    function createBarChart(canvasId, labels, values, title) {
      new Chart(document.getElementById(canvasId), {
        type: 'bar',
        data: { labels, datasets: [{ label: title, data: values.map(v => parseFloat(v)||0), backgroundColor: 'rgba(42,125,106,0.7)' }] },
        options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: title } } }
      });
    }

    // Generate report handler
    document.getElementById('generateBtn').addEventListener('click', () => {
      const file = document.getElementById('csvFile').files[0];
      if (!file) return alert('Select a lab results CSV file.');
      const reader = new FileReader();
      reader.onload = e => {
        const data = parseCSV(e.target.result);
        // Sample info
        populateSampleInfo(data);
        // Cannabinoids
        const canRows = cannabinoidParams.map(p => ({ name: p.name, value: data[p.key]||'0', range: p.range }));
        fillTable('#cannabinoidsTable', canRows);
        createBarChart('cannabinoidChart', canRows.map(r=>r.name), canRows.map(r=>r.value), 'Cannabinoids (%)');
        // Terpenes
        const terpRows = terpeneParams.map(p => ({ name: p.name, value: data[p.key]||'0', range: p.range }));
        fillTable('#terpenesTable', terpRows);
        createBarChart('terpeneChart', terpRows.map(r=>r.name), terpRows.map(r=>r.value), 'Terpenes (%)');
        // Moisture & aW
        document.getElementById('moisture').textContent = data['Moisture(%)'] ? data['Moisture(%)'] + '%' : '--';
        document.getElementById('aw').textContent = data['aW(%)'] || '--';
        // Optional customer logo
        const logoFile = document.getElementById('customerLogo').files[0];
        if (logoFile) {
          const lr = new FileReader(); lr.onload = ev => {
            const img = document.createElement('img'); img.src = ev.target.result;
            img.className = 'customer-logo'; document.querySelector('.header').appendChild(img);
          };
          lr.readAsDataURL(logoFile);
        }
        document.getElementById('report').style.display = 'block';
        // Save snapshot for download
        window.reportHTML = '<!DOCTYPE html>' + document.documentElement.outerHTML;
      };
      reader.readAsText(file);
    });

    // Download handler
    document.getElementById('downloadBtn').addEventListener('click', () => {
      if (!window.reportHTML) return;
      const blob = new Blob([window.reportHTML], { type: 'text/html' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = 'cannabis_report.html'; a.click();
    });
  </script>
</body>
</html>
